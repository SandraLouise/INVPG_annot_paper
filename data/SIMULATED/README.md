# Generating inversion set and synthetic haplotypes

> [!NOTE]\
> Simply cloning this repo does not create the directory structure. You may need to adapt the command line instructions to your own data to proceed.

**This pipeline only works for generating synthetic haplotypes from a single chromosome.**

## Steps

1) Generating one inversion VCF (for all datasets with different SNP divergences)
2) Generating a synthetic haplotype with a controlled SNP rate (+ set of SNPs in VCF format)
3) Simulating inversions in synthetic haplotypes
    - 3.A: Simulate 1 synthetic haplotype with the full set of inversions (_i.e._ 100)
    - 3.B: Simulate 9 synthetic haplotypes with half of the inversions (_i.e._ 50), randomly picked for each haplotype 


## Full process with the automatized scripts

The automatized scripts automatize steps 2) and 3) for a given SNP rate, and generate the input files for the different pangenome graph tools:

- `create_genome_datasets_2haplotypes.sh`
- `create_genome_datasets_10haplotypes.sh`

### Prepare the input data for the automatized script

2 input data to prepare : the reference genome (correct fasta format) + the inversion VCF

#### Input chromosome files

Reference genome requirements: one single chromosome + header in panSN format (eg. `>chm13#0#chr21`)
    
1 set of simulations:
- Simulations based on human chr21 (28 Mb) : `chr21.fa`
    - Sub-sequence of the CHM13 chr21 (no N) : from 17 Mb - to 45 Mb, to avoid peri-centromeric/sub-telomeric regions

#### Inversion generation

Script: `01_generate_random_inversion_set.py`

Parameters:
- `REF` [str]: path to the reference fasta file
- `number` [int]: number of inversions to simulate (reproductibility: **100**)
- `SEED`[int]: fixes the random seed for reproducibility

### Output file
- `VCF` [str]: path to output simulated inversion set

```bash
python 01_generate_random_inversion_set.py <REF> <number> <SEED> > <VCF>
```

For the simulation on human chr21, the file: `chr21_sim_100inv.vcf` was obtained with the following command:

```bash
python 01_generate_random_inversion_set.py chr21.fa 100 10 > chr21_sim_100inv.vcf
```

### Automatized script for 2-haplotype dataset generation

Once the VCF with the 100 INV has been generated, the script `create_genome_datasets_2haplotypes.sh` automatizes the generation of 2-haplotypes datasets for a given SNP divergence, with the correct formats of fasta files and input files for the different pangenome graph pipelines.

Parameters:  
- `REF`: input fasta file (haplotype 1)
- `DIV`: SNP divergence
- `INV`: set of 100 INV in VCF format (generated by `01_generate_random_inversion_set.py`)
- `REF_ID`: reference haplotype name (for input files of pg pipelines)
- `SIM_ID`: simulated haplotype name (for naming the fasta file, the sequence header and for input files of pg pipelines)
- `OUT_DIR`: to put the simulated sequences (can be the same directory for several experiments)
- `SEED`: setting the random seed. If the command is run again with the same seed, the same random sequence will be generated

```bash
./create_genome_datasets_2haplotypes.sh <REF> <DIV> <INV> <REF_ID> <SIM_ID> <OUT_DIR> <SEED>
```

Example for the human chr21:
```bash
./create_genome_datasets_2haplotypes.sh chr21.fa 0.1 chr21_sim_100inv.vcf chm13 simulated1 genomes_2hap 10
```

Output: 
- The fasta file of the simulated genome `OUT_DIR/` (with header respecting the panSN spec, eg. `>chm13#0#chr21`) (note: the reference haplotype is not duplicated here)
- `OUT_DIR/` contains a  subdir `cactus_genomes/` with the ref + simulated genomes formatted for cactus
- Input files for pg pipelines: `[mgc|cactus|pggb|minigraph]_input_2hap_div0.1.txt` with the absolute paths of the pairs of genomes for each pipeline

To simulate other SNP divergences, the same command line can be used, changing only the DIV parameter. The same output directoty can be used for all divergences.

Command used for human chr21 div 0% simulation:
```bash
cd ../data/new_sim_human/
./create_genome_datasets_2haplotypes.sh chr21.fa 0 .chr21_sim_100inv.vcf chm13 simulated1 genomes_2hap 25
```

### Automatized script for 10-haplotype dataset generation

Once the VCF with the 100 INV has been generated, the script `create_genome_datasets_10haplotypes.sh` automatizes the generation of 10-haplotypes datasets for a given SNP divergence, with the correct formats of fasta files and input files for the different pangenome graph pipelines.

Note 1: for each new haplotype (n=9), 50 inversions are sampled among the set of 100, idem for SNP in a set of SNPs corresponding to 2 times the desired divergence (`DIV` param) 

Note 2: SNPs and INV are sampled independently, ie. SNPs alleles inside the inversions are not fixed with the inversions 

Note 3: the number of haplotypes is not a parameter, it could be changed by changing a variable value inside the script *BUT* it won't work for the input cactus file that requires a phylogenetic tree of the haplotypes (here it is hard-coded for 10 haplotypes)

Parameters:  
- `REF`: input fasta file (haplotype 1)
- `DIV`: SNP divergence
- `INV`: set of 100 INV in VCF format (generated by `01_generate_random_inversion_set.py`)
- `REF_ID`: reference haplotype name (for input files of pg pipelines)
- `SIM_ID`: simulated haplotype prefix (for naming the fasta file, the sequence header and for input files of pg pipelines)
- `OUT_DIR`: to put the simulated sequences (can be the same directory for several experiments)
- `SEED`: setting the random seed. If the command is run again with the same seed, the same random sequence will be generated

```bash
./create_genome_datasets_10haplotypes.sh <REF> <DIV> <INV> <REF_ID> <SIM_ID> <OUT_DIR> <SEED>
```

Command used for human chr21 div 1% simulation:
```bash
./create_genome_datasets_10haplotypes.sh chr21.fa 1 chr21_sim_100inv.vcf chm13 tenhaplo genomes_10hap 10
```

Output: 
- The fasta file of the simulated genome `OUT_DIR/` (with header respecting the panSN spec, eg. `>chm13#0#chr21`) (note: the reference haplotype is not duplicated here)
- `OUT_DIR/` contains a  subdir `cactus_genomes/` with the ref + simulated genomes formatted for cactus
- Input files for pg pipelines: `[mgc|cactus|pggb]_input_10hap_div0.1.txt` with the absolute paths of all haplotypes for each pipeline
- `OUT_DIR_VCF/` contains 2 vcf files for each simulated haplotype, with their SNP and inversion sets.
- 2 txt files `*_inv_distrib.txt` and `*_inv_histo.txt` with the distribution of inversions among the 9 haplotypes, to be sure that each inversion is simulated in at least one haplotype. 